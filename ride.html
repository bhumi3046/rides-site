<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Wild Rydes</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Serverless web application example">
    <meta name="author" content="">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
    <link rel="stylesheet" href="/css/ride.css">
    <link rel="stylesheet" href="/css/message.css">

    <style>
        /* Custom styles for the map container */
        .map-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            margin-top: 30px;
        }

        .map-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        #mapView {
            height: 500px;
        }
    </style>
</head>

<body>

    <div class="info panel panel-default">
        <div class="panel-heading">
            <button id="request" class="btn btn-primary" disabled="disabled">Set pickup</button>
            <div class="dropdown pull-right">
                <button id="accountLink" class="btn" type="button" data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false">
                    Account <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="accountLink">
                    <li><a id="signOut" href="#">Sign out</a></li>
                </ul>
            </div>
        </div>
        <div class="panel-body">
            <ol id="updates">
                <li>Welcome! Click the map to set your pickup location.</li>
            </ol>
        </div>
    </div>

    <!-- ArcGIS Map Section -->
    <div class="container">
        <h3>Our Exact Location (Interactive Map)</h3>
        <div id="mapView"></div>
    </div>

    <!-- Modals for Auth Token -->
    <div id="authTokenModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="authToken">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Your Auth Token</h4>
                </div>
                <div class="modal-body">
                    <textarea class="authToken"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/vendor/jquery-3.1.0.js"></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/vendor/aws-cognito-sdk.min.js"></script>
    <script src="js/vendor/amazon-cognito-identity.min.js"></script>
    <script src="https://js.arcgis.com/4.6/"></script>

    <script src="js/config.js"></script>
    <script src="js/cognito-auth.js"></script>
    <script src="js/esri-map.js"></script>
    <script src="js/ride.js"></script>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/geometry/Point",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/geometry/SpatialReference",
            "dojo/domReady!"
        ], function (Map, MapView, Graphic, Point, SimpleMarkerSymbol, SpatialReference) {

            // Coordinates for Greater Noida
            var center = { lat: 28.4573787, lng: 77.52754575 };

            // Create the map
            var map = new Map({
                basemap: "streets-navigation-vector"  // You can choose any basemap you prefer
            });

            // Create the map view
            var view = new MapView({
                container: "mapView", // The div ID where the map will be rendered
                map: map,
                center: [center.lng, center.lat], // Set center of map to Greater Noida
                zoom: 14
            });

            // Create a marker symbol for the pickup location
            var markerSymbol = new SimpleMarkerSymbol({
                color: [226, 119, 40], // Orange color
                size: 10,
                outline: {
                    color: [255, 255, 255],
                    width: 1
                }
            });

            // Event listener to handle click on the map and set the pickup location
            view.on("click", function (event) {
                var point = new Point({
                    longitude: event.mapPoint.longitude,
                    latitude: event.mapPoint.latitude,
                    spatialReference: new SpatialReference({ wkid: 4326 })
                });

                // Create a graphic (marker) at the clicked point
                var pointGraphic = new Graphic({
                    geometry: point,
                    symbol: markerSymbol
                });

                // Add the marker to the map
                view.graphics.removeAll();
                view.graphics.add(pointGraphic);

                // Save the location for pickup
                WildRydes.map.selectedPoint = {
                    latitude: point.latitude,
                    longitude: point.longitude
                };

                // Enable the request button
                $('#request').prop('disabled', false);
                $('#request').text('Request Unicorn');
            });

        });

        // Request Unicorn function (connected to API call)
        function requestUnicorn(pickupLocation) {
            $.ajax({
                method: 'POST',
                url: _config.api.invokeUrl + '/ride',
                headers: {
                    Authorization: WildRydes.authToken
                },
                data: JSON.stringify({
                    PickupLocation: {
                        Latitude: pickupLocation.latitude,
                        Longitude: pickupLocation.longitude
                    }
                }),
                contentType: 'application/json',
                success: completeRequest,
                error: function ajaxError(jqXHR, textStatus, errorThrown) {
                    console.error('Error requesting ride: ', textStatus, ', Details: ', errorThrown);
                    console.error('Response: ', jqXHR.responseText);
                    alert('An error occurred when requesting your unicorn:\n' + jqXHR.responseText);
                }
            });
        }

        function completeRequest(result) {
            var unicorn;
            var pronoun;
            console.log('Response received from API: ', result);
            unicorn = result.Unicorn;
            pronoun = unicorn.Gender === 'Male' ? 'his' : 'her';
            displayUpdate(unicorn.Name + ', your ' + unicorn.Color + ' unicorn, is on ' + pronoun + ' way.');
            animateArrival(function animateCallback() {
                displayUpdate(unicorn.Name + ' has arrived. Giddy up!');
                WildRydes.map.unsetLocation();
                $('#request').prop('disabled', 'disabled');
                $('#request').text('Set Pickup');
            });
        }

        // Trigger the request when the user clicks on the 'Request Unicorn' button
        $(function onDocReady() {
            $('#request').click(function (event) {
                var pickupLocation = WildRydes.map.selectedPoint;
                event.preventDefault();
                requestUnicorn(pickupLocation);
            });
        });

        function displayUpdate(text) {
            $('#updates').append($('<li>' + text + '</li>'));
        }
    </script>

</body>

</html>
